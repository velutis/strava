<!DOCTYPE html>
<html>
<head>
<link href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
  
<script>
$(document).ready(function(){
  
function getUrlVars()
{
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}
  
  var code = getUrlVars()["code"];
  if (typeof code != 'undefined')
  {
     $.post("https://www.strava.com/oauth/token?client_id=21332&client_secret=26a0c5a8c13189765f334b7d645ef36f8ab6ab83&code=" + code, function(data) {
       //store token
       
       var t = "8";
       t += "2";
       t += "8";
       t += "f";
       t += "c";
       t += "a";
       t += "3";
       t += "0";
       t += "1";
       t += "d";
       t += "b";
       t += "b";
       t += "7";
       t += "1";
       t += "4";
       t += "c";
       t += "f";
       t += "d";
       t += "7";
       t += "5";
       t += "3";
       t += "1";
       t += "9";
       t += "c";
       t += "8";
       t += "b";
       t += "2";
       t += "2";
       t += "5";
       t += "e";
       t += "3";
       t += "2";
       t += "9";
       t += "0";
       t += "e";
       t += "3";
       t += "f";
       t += "3";
       t += "e";
       t += "8";
       
       
// basic auth
var gh = new GitHub({
   username: 'velutis',
   token: t
   
});

var me = gh.getUser(); // no user specified defaults to the user for whom credentials were provided
  

me.listRepos(function(err, repos) {
    try{
const options = {
            author: {name: 'Author Name', email: 'author@example.com'},
            committer: {name: 'Committer Name', email: 'committer@example.com'}
         };
  //repos[0].writeFile("master", "testas.txt", "content", "message", options, nil)

      remoteRepo = gh.getRepo('velutis', 'strava'); 
      
         $.getJSON("https://www.strava.com/api/v3/athlete?access_token=data.token&callback=?", function(dataAthlete) {
   
      
  remoteRepo.writeFile("master",  "tokens/" + dataAthlete.id, data.token, "message", options, function(error, commit) {

            }); 
         }); 
    }
    catch(err) {
    alert(err.message);
}

});

       
     });
  }

  function getUserData(id, table) {
   $.getJSON("https://www.strava.com/api/v3/clubs/" + id + "/members?access_token=204164d46603932ae9a1911c2137c02a953e62bd&callback=?", function(data) {
                     
                 
                    
                    var tbl_body = "";
    var odd_even = false;
    $.each(data, function() {
     
        var userJson = this;
      //tbl_row += "<td>"+this.id+"</td>";
      var rideTimee = 0; 
      var rideTime = 0;
      var runTime = 0;
      var swimTime = 0;
      var unknownTime = 0;
      
      var at = "";
      
       jQuery.ajax({
        url: "https://velutis.github.io/strava/tokens/" + userJson.id + ".tok",
        success: function (result) {
           
              at = result;
        },
        async: false
    });
      
      //get token
      $.get( "https://velutis.github.io/strava/tokens/" + userJson.id + ".tok", function( dataToken ) {
 
       
});
      
      //get activitis for member       
          $.getJSON("https://www.strava.com/api/v3/athletes/" + userJson.id + "/activities?access_token=" + at + "&after=1506816000&before=1512086400&per_page=200&callback=?", function(datamemberactivities) {
             //   tbl_body += "<tr><td>"+userJson.firstname + " " + userJson.lastname+"</td><td>"+"ok"+"</td></tr>";
            
             $.each(datamemberactivities, function() {
               if (this.type == "Ride")
                 {
                  
                     //tbl_body += "<tr><td></td><td></td><td>"+this.type+"</td><td>"+this.moving_time+"</td></tr>";   
                       rideTime += this.moving_time / 3600;

                 }
               else if (this.type == "Run")
                 {
                   //tbl_body += "<tr><td></td><td></td><td>"+this.type+"</td><td>"+this.moving_time+"</td></tr>";   
                   runTime += this.moving_time / 3600;
                 }
               else if (this.type == "Swim")
                 {
                   //tbl_body += "<tr><td></td><td></td><td>"+this.type+"</td><td>"+this.moving_time+"</td></tr>";   
                   swimTime += this.moving_time / 3600;
                 }
                else
                 {
                   //tbl_body += "<tr><td></td><td></td><td>"+this.type+"</td><td>"+this.moving_time+"</td></tr>";   
                   unknownTime += this.moving_time / 3600;
                 }
                
             });
            var totalTime = ((rideTime + runTime + swimTime));
         
           
            table.row.add( [userJson.firstname + " " + userJson.lastname, 
                            swimTime.toFixed(2), 
                            rideTime.toFixed(2), 
                            runTime.toFixed(2), 
                            totalTime.toFixed(2),
                            (swimTime * 100 / totalTime).toFixed(2),
                            (rideTime * 100 / totalTime).toFixed(2),
                            (runTime * 100 / totalTime).toFixed(2),
                             unknownTime.toFixed(2)] ).draw( false );

            })
        .fail(function() 
              {

             table.row.add( [userJson.firstname + " " + userJson.lastname+" Authorization required", 0, 0, 0, 0, 0,0,0,0] ).draw( false );
              
              });
      
       
       
    })
     
                });
       }

      
   var tableKaunas = $('#table_kaunas').DataTable();
  var tableVilnius = $('#table_vilnius').DataTable();
  
getUserData(265173, tableVilnius);
  getUserData(322407, tableKaunas);
  
        


               


});
</script>
</head>
<body>
<a href="https://www.strava.com/oauth/authorize?client_id=21332&response_type=code&redirect_uri=https://velutis.github.io/strava/&scope=public&approval_prompt=force">
          <img src="img/LogInWithStrava.png" alt="Login With Strava" />
        </a>
    <p>Activities from 2017.10.1 till 2017.12.01</p>
  <p>VILNIUS</p>
    <table id="table_vilnius">
      <thead>
        <tr>
            <th>Name</th>
            <th>Swim</th>
            <th>Bike</th>
            <th>Run</th>
          <th>Total</th>
          <th>Swim %</th>
            <th>Bike %</th>
            <th>Run %</th>
          <th>Other</th>
        </tr>
    </thead>

<tbody>
  
</tbody>
</table> 
  <p>KAUNAS</p>
  <table id="table_kaunas">
      <thead>
        <tr>
            <th>Name</th>
            <th>Swim</th>
            <th>Bike</th>
            <th>Run</th>
          <th>Total</th>
          <th>Swim %</th>
            <th>Bike %</th>
            <th>Run %</th>
          <th>Other</th>
        </tr>
    </thead>

<tbody>
  
</tbody>
</table> 
    
   
    
</body>
</html>
